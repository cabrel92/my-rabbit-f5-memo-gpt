# Proc√©dure pour Machine Windows Isol√©e (via machine interm√©diaire avec Internet)

## Architecture

```
[Machine avec Internet] ‚Üí [Transfert] ‚Üí [Windows Isol√©] ‚Üí [SSH] ‚Üí [Serveurs RHEL Isol√©s]
     (Pr√©paration)                       (Jumphost)              (Cibles)
```

## Phase 1 : Pr√©paration sur Machine avec Internet

### 1.1 T√©l√©charger Python
```powershell
# T√©l√©charger Python 3.11.7 installer
# URL: https://www.python.org/ftp/python/3.11.7/python-3.11.7-amd64.exe
# Ou version portable : python-3.11.7-embed-amd64.zip
```

### 1.2 T√©l√©charger Ansible et d√©pendances
```powershell
# Cr√©er dossier de packages
mkdir C:\ansible-offline-bundle

# T√©l√©charger packages Python
pip download -d C:\ansible-offline-bundle ansible-core==2.15.8
pip download -d C:\ansible-offline-bundle paramiko jinja2 PyYAML cryptography
```

### 1.3 T√©l√©charger OpenSSH pour Windows
```powershell
# T√©l√©charger depuis GitHub
# URL: https://github.com/PowerShell/Win32-OpenSSH/releases/download/v9.5.0.0p1-Beta/OpenSSH-Win64.zip
```

### 1.4 T√©l√©charger paquets pour RHEL (Erlang, RabbitMQ, d√©pendances)
```powershell
# Erlang 27.1.2
Invoke-WebRequest -Uri "https://github.com/erlang/otp/releases/download/OTP-27.1.2/otp_src_27.1.2.tar.gz" -OutFile "erlang.tar.gz"

# RabbitMQ 4.1.0
Invoke-WebRequest -Uri "https://github.com/rabbitmq/rabbitmq-server/releases/download/v4.1.0/rabbitmq-server-generic-unix-4.1.0.tar.xz" -OutFile "rabbitmq.tar.xz"

# D√©pendances RHEL (via conteneur ou serveur RHEL temporaire avec Internet)
# Voir script bash pr√©c√©dent pour yumdownloader
```

### 1.5 Cr√©er le bundle complet
```powershell
# Structure du bundle
C:\ansible-complete-bundle\
‚îú‚îÄ‚îÄ python\
‚îÇ   ‚îî‚îÄ‚îÄ python-3.11.7-amd64.exe
‚îú‚îÄ‚îÄ openssh\
‚îÇ   ‚îî‚îÄ‚îÄ OpenSSH-Win64.zip
‚îú‚îÄ‚îÄ ansible\
‚îÇ   ‚îî‚îÄ‚îÄ *.whl (tous les packages pip)
‚îú‚îÄ‚îÄ packages\
‚îÇ   ‚îú‚îÄ‚îÄ erlang\
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ otp_src_27.1.2.tar.gz
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ erlang-deps-rhel.tar.gz
‚îÇ   ‚îî‚îÄ‚îÄ rabbitmq\
‚îÇ       ‚îî‚îÄ‚îÄ rabbitmq-server-generic-unix-4.1.0.tar.xz
‚îî‚îÄ‚îÄ projet\
    ‚îú‚îÄ‚îÄ ansible.cfg
    ‚îú‚îÄ‚îÄ inventory.ini
    ‚îú‚îÄ‚îÄ group_vars\
    ‚îú‚îÄ‚îÄ deploy_erlang.yml
    ‚îú‚îÄ‚îÄ deploy_rabbitmq.yml
    ‚îú‚îÄ‚îÄ validate.yml
    ‚îî‚îÄ‚îÄ deploy.ps1

# Cr√©er archive
Compress-Archive -Path "C:\ansible-complete-bundle" -DestinationPath "C:\ansible-bundle.zip"
```

## Phase 2 : Transfert vers Windows Isol√©

### 2.1 M√©thodes de transfert possibles
- **USB/Disque externe** : Copier ansible-bundle.zip
- **R√©seau interne** : Si partage r√©seau disponible entre machine Internet et Windows isol√©
- **Autre support** : CD/DVD, disque r√©seau temporaire

### 2.2 V√©rifier l'int√©grit√©
```powershell
# Sur machine avec Internet (avant transfert)
Get-FileHash -Algorithm SHA256 C:\ansible-bundle.zip | Out-File bundle-checksum.txt

# Sur Windows isol√© (apr√®s transfert)
Get-FileHash -Algorithm SHA256 C:\Temp\ansible-bundle.zip
# Comparer avec bundle-checksum.txt
```

## Phase 3 : Installation sur Windows Isol√©

### 3.1 Extraire le bundle
```powershell
# Extraire
Expand-Archive -Path "C:\Temp\ansible-bundle.zip" -DestinationPath "C:\Ansible"
```

### 3.2 Installer Python
```powershell
cd C:\Ansible\python
.\python-3.11.7-amd64.exe /quiet InstallAllUsers=1 PrependPath=1

# V√©rifier
python --version
```

### 3.3 Installer Ansible (offline)
```powershell
cd C:\Ansible\ansible
pip install --no-index --find-links=. ansible-core

# V√©rifier
ansible --version
```

### 3.4 Installer OpenSSH
```powershell
Expand-Archive -Path "C:\Ansible\openssh\OpenSSH-Win64.zip" -DestinationPath "C:\Program Files\OpenSSH"

# Ajouter au PATH
$env:Path += ";C:\Program Files\OpenSSH"
[Environment]::SetEnvironmentVariable("Path", $env:Path, "Machine")

# V√©rifier
ssh -V
```

### 3.5 D√©ployer le projet Ansible
```powershell
# Copier la structure du projet
Copy-Item -Path "C:\Ansible\projet" -Destination "C:\ansible-rabbitmq" -Recurse
```

## Phase 4 : Configuration SSH

### 4.1 G√©n√©rer cl√©s SSH sur Windows isol√©
```powershell
New-Item -Path "$env:USERPROFILE\.ssh" -ItemType Directory -Force
ssh-keygen -t rsa -b 4096 -f "$env:USERPROFILE\.ssh\ansible_rsa" -N '""'

# Afficher la cl√© publique
type "$env:USERPROFILE\.ssh\ansible_rsa.pub"
# ‚Üí Copier cette cl√© (manuellement ou via fichier texte)
```

### 4.2 Transf√©rer la cl√© publique vers RHEL
**Option A : Connexion directe (si possible)**
```powershell
# Premi√®re connexion avec mot de passe
ssh ansible@192.168.1.10
```

**Option B : Via fichier interm√©diaire**
```powershell
# Sauvegarder la cl√© publique dans un fichier
type "$env:USERPROFILE\.ssh\ansible_rsa.pub" > C:\Temp\pubkey.txt
# Copier pubkey.txt vers RHEL (USB, r√©seau interne, etc.)
```

### 4.3 Configurer sur chaque serveur RHEL
```bash
# Sur RHEL (en tant que root)
useradd -m -s /bin/bash ansible
passwd ansible

# Installer la cl√© publique
su - ansible
mkdir -p ~/.ssh && chmod 700 ~/.ssh
# Coller le contenu de la cl√© publique
nano ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
exit

# Configurer sudo
echo "ansible ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/ansible
chmod 440 /etc/sudoers.d/ansible
```

### 4.4 Configurer SSH sur Windows
```powershell
notepad "$env:USERPROFILE\.ssh\config"
```
```
Host rhel-dev-1
    HostName 192.168.1.10
    User ansible
    IdentityFile ~/.ssh/ansible_rsa
    StrictHostKeyChecking no
```

## Phase 5 : D√©ploiement

### 5.1 Tester la connectivit√©
```powershell
cd C:\ansible-rabbitmq
ansible rhel_servers -m ping
```

### 5.2 D√©ployer
```powershell
# D√©ployer tout
.\deploy.ps1 -Action all

# Ou √©tape par √©tape
.\deploy.ps1 -Action erlang
.\deploy.ps1 -Action rabbitmq
.\deploy.ps1 -Action validate
```

## Phase 6 : Validation

### 6.1 V√©rifier l'installation
```powershell
ansible-playbook validate.yml
```

### 6.2 Acc√©der √† RabbitMQ Management
```
http://192.168.1.10:15672
Utilisateur: admin
Mot de passe: AdminPass123
```

---

## R√©sum√© de la Proc√©dure

| √âtape | O√π | Action | Transfert n√©cessaire |
|-------|-----|--------|---------------------|
| 1 | Machine Internet | T√©l√©charger tous les packages | Non |
| 2 | Machine Internet | Cr√©er bundle complet (ZIP) | Non |
| 3 | Entre machines | Transf√©rer bundle vers Windows isol√© | **OUI (USB/R√©seau)** |
| 4 | Windows isol√© | Installer Python, Ansible, OpenSSH | Non |
| 5 | Windows isol√© | G√©n√©rer cl√©s SSH | Non |
| 6 | Entre Windows/RHEL | Copier cl√© publique vers RHEL | **OUI (SSH/USB)** |
| 7 | Windows isol√© | Configurer Ansible (inventory, config) | Non |
| 8 | Windows isol√© | Tester connectivit√© SSH | Non |
| 9 | Windows isol√© | D√©ployer avec Ansible | Non |
| 10 | Windows isol√© | Valider installation | Non |

## Points de Transfert Critiques

### Transfert 1 : Machine Internet ‚Üí Windows Isol√©
**Contenu** : ansible-bundle.zip (~100-200 MB)
**M√©thodes** : USB, partage r√©seau temporaire, support physique

### Transfert 2 : Windows Isol√© ‚Üí Serveurs RHEL
**Contenu** : Cl√© SSH publique (~1 KB)
**M√©thodes** : SSH (si connexion r√©seau), USB + copie manuelle

## Checklist Compl√®te

**Sur Machine avec Internet :**
- [ ] T√©l√©charger Python
- [ ] T√©l√©charger Ansible + d√©pendances
- [ ] T√©l√©charger OpenSSH
- [ ] T√©l√©charger Erlang 27.1.2
- [ ] T√©l√©charger RabbitMQ 4.1.0
- [ ] T√©l√©charger d√©pendances RHEL
- [ ] Cr√©er structure projet Ansible
- [ ] Cr√©er bundle ZIP
- [ ] Calculer checksum

**Transfert :**
- [ ] Copier bundle sur support (USB)
- [ ] Transf√©rer vers Windows isol√©
- [ ] V√©rifier checksum

**Sur Windows Isol√© :**
- [ ] Extraire bundle
- [ ] Installer Python
- [ ] Installer Ansible (offline)
- [ ] Installer OpenSSH
- [ ] G√©n√©rer cl√©s SSH
- [ ] Configurer SSH config
- [ ] Copier cl√© publique vers RHEL

**Sur Serveurs RHEL :**
- [ ] Cr√©er utilisateur ansible
- [ ] Installer cl√© SSH publique
- [ ] Configurer sudo

**D√©ploiement :**
- [ ] Tester ping Ansible
- [ ] D√©ployer Erlang
- [ ] D√©ployer RabbitMQ
- [ ] Valider installation
- [ ] Tester Management UI

---

## Estimation de Temps

- **Pr√©paration (Machine Internet)** : 1-2 heures
- **Transfert** : 15-30 minutes (selon m√©thode)
- **Installation Windows** : 30 minutes
- **Configuration SSH** : 30 minutes
- **D√©ploiement Ansible** : 1-2 heures (compilation Erlang)
- **Total** : **3-5 heures**

Cette proc√©dure est **reproductible** et **automatisable** une fois le bundle cr√©√© ! üöÄ
